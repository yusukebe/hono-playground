<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/new.min.css" />
    <link rel="stylesheet" data-name="vs/editor/editor.main" href="/vs/editor/editor.main.css" />
    <link rel="stylesheet" href="/style.css" />
    <link rel="icon shortcut" href="/favicon.png" />
    <script>
      var require = { paths: { vs: '/vs' } }
    </script>
    <script src="/vs/loader.js"></script>
    <script src="/vs/editor/editor.main.nls.js"></script>
    <script src="/vs/editor/editor.main.js"></script>
    <script type="module">
      import Alpine from 'https://esm.sh/alpinejs'
      import initSwc, { transformSync } from 'https://esm.sh/@swc/wasm-web'

      Alpine.store('app', {
        init() {
          this.dispatch()
          this.createMonaco()
          this.formatJson()
        },
        createMonaco() {
          const editor = monaco.editor.create(document.getElementById('editor'), {
            value: [this.code].join('\n'),
            language: 'javascript',
            minimap: { enabled: false },
          })
          editor.getModel().onDidChangeContent((event) => {
            this.code = editor.getValue()
            this.dispatch()
          })
        },
        formatJson() {
          if (this.body == null || this.body.trim() === '') {
            return
          }
          try {
            let formattedBody = this.body.replace(/(\w+)\s*:/g, '"$1":')
            this.body = JSON.stringify(JSON.parse(formattedBody), null, 2)
          } catch (e) {
            console.error('Invalid JSON:', e)
          }
        },
        async dispatch() {
          const code = this.code
          try {
            await initSwc()
            const importSource = `import { jsx, Fragment } from 'https://esm.sh/hono/jsx'\n`
            const { code } = transformSync(importSource + this.code, {
              jsc: {
                parser: {
                  syntax: 'typescript',
                  tsx: true,
                },
                transform: {
                  react: {
                    pragma: 'jsx',
                    pragmaFrag: 'Fragment',
                    throwIfNamespace: true,
                    development: false,
                    useBuiltins: false,
                  },
                },
              },
            })
            const blobURL = URL.createObjectURL(new Blob([code], { type: 'text/javascript' }))
            const { default: app } = await import(/*@vite-ignore */ blobURL)

            const res = await app.request(this.path, {
              method: this.method,
              headers: this.method !== 'get' ? { 'Content-Type': 'application/json' } : undefined,
              body: this.method !== 'get' ? this.body : undefined,
            })
            this.info.status = res.status
            this.info.headers = [...res.headers.entries()]
              .reduce((acc, [key, value]) => {
                return acc + `${key}: ${value}, `
              }, '')
              .slice(0, -2)
            this.result = await res.text()
          } catch (e) {
            console.log(`${e}`)
          }
        },
        code: `import { Hono } from 'https://esm.sh/hono'

const app = new Hono()

app.get('/hello', (c) => {
  const name = c.req.query('name')
  return c.text(\`Hello \${name}\!\`)
})

app.get('/jsx', (c) => {
  return c.html(
    <div>
      <h1>Hello JSX!</h1>
    </div>
  )
})

app.post('/json', async (c) => {
  try {
    const body = await c.req.json();

    return c.json(body);
  } catch (error) {
    return c.text('Bad Request: Invalid JSON',{ status: 400 });
  }
});

export default app`,
        method: 'get',
        path: '/hello?name=Hono',
        result: 'loading...',
        info: {
          status: undefined,
          headers: '',
        },
      })
      window.Alpine = Alpine
      window.Alpine.start()
    </script>
    <title>Hono Playground</title>
  </head>
  <body>
    <header>
      <h1>Hono Playground</h1>
    </header>
    <main x-data>
      <div id="editor"></div>
      <div id="browser">
        <form @submit.prevent="$store.app.dispatch()">
          <select x-model="$store.app.method">
            <option value="get">GET</option>
            <option value="post">POST</option>
            <option value="put">PUT</option>
            <option value="delete">DELETE</option>
          </select>
          <input type="text" x-model="$store.app.path" autocomplete="off" />
          <button>Send</button>
        </form>
        <div id="body" x-show="$store.app.method !== 'get'">
          <div>
            Body JSON Content
            <button @click="$store.app.formatJson()">Format</button>
          </div>
          <br />
          <textarea
            placeholder="Enter body JSON..."
            x-model="$store.app.body"
            autocomplete="off"
            rows="4"
          ></textarea>
        </div>
        <div id="result">
          <div>
            <small x-text="$store.app.info.status"></small><br />
            <small x-text="$store.app.info.headers"></small>
          </div>
          <hr />
          <div x-text="$store.app.result"></div>
        </div>
      </div>
    </main>
    <footer>
      Powered by <a href="https://hono.dev">Hono</a>,
      <a href="https://github.com/yusukebe/hono-playground/blob/main/index.html">the code</a>.
    </footer>
  </body>
</html>
